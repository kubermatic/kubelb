# Copyright 2026 The KubeLB Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Default Backend Ingress Test
# Verifies:
# - Ingress with ONLY defaultBackend (no rules) creates Route CRD
# - Route CRD has correct labels
# - Status propagation (LoadBalancer IP)
# - HTTP request to any path returns default backend response
# - Cleanup removes Route CRD
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: default-backend-ingress
  labels:
    all:
    test: default-backend
    resource: ingress
    layer: layer7
spec:
  description: |
    Test Ingress with defaultBackend only (no rules).
    Creates ClusterIP service pointing to echo-shared, creates Ingress with only defaultBackend,
    verifies Route CRD, tests HTTP connectivity to any path,
    then verifies cleanup removes Route CRD.
  bindings:
    - name: name
      value: echo-default
    - name: kubelb_namespace
      value: tenant-primary
  steps:
    # Step 1: Create ClusterIP service pointing to echo-shared
    - name: create-service
      description: Create ClusterIP service pointing to echo-shared
      cluster: tenant1
      try:
        - apply:
            resource:
              apiVersion: v1
              kind: Service
              metadata:
                name: echo-default
                namespace: default
              spec:
                type: ClusterIP
                selector:
                  app: echo-shared
                ports:
                  - port: 80
                    targetPort: 5678

    # Step 2: Create Ingress with defaultBackend only (no rules)
    - name: create-ingress
      description: Create Ingress with defaultBackend only
      cluster: tenant1
      try:
        - apply:
            resource:
              apiVersion: networking.k8s.io/v1
              kind: Ingress
              metadata:
                name: echo-default
                namespace: default
              spec:
                ingressClassName: kubelb
                defaultBackend:
                  service:
                    name: echo-default
                    port:
                      number: 80

    # Verify Route CRD in kubelb cluster
    - name: verify-route-crd
      description: Verify Route CRD exists with correct labels
      use:
        template: ../../../../step-templates/common/verify-route-crd.yaml
        with:
          bindings:
            - name: resource_name
              value: ($name)
            - name: expected_kind
              value: Ingress.networking.k8s.io
            - name: kubelb_namespace
              value: ($kubelb_namespace)

    # Step 4: Verify status propagation to tenant Ingress
    - name: verify-status
      description: Verify Ingress gets LoadBalancer IP
      use:
        template: ../../../../step-templates/ingress/verify-ingress-status.yaml
        with:
          bindings:
            - name: ingress_name
              value: ($name)

    # Step 5: Verify HTTP request to any path returns default backend
    - name: verify-http
      description: Verify HTTP response from default backend
      cluster: tenant1
      try:
        - script:
            skipCommandOutput: true
            timeout: 120s
            content: |
              set -e
              # Wait for IP to be available
              echo "Waiting for Ingress IP..."
              for i in $(seq 1 30); do
                IP=$(kubectl get ingress echo-default -n default \
                  -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
                if [ -n "$IP" ]; then
                  echo "Got Ingress IP: $IP"
                  break
                fi
                echo "Attempt $i: waiting for IP..."
                sleep 3
              done

              if [ -z "$IP" ]; then
                echo "FAILED: No LoadBalancer IP for Ingress"
                kubectl get ingress echo-default -n default -o yaml
                exit 1
              fi

              EXPECTED="hello-shared"

              # Test multiple paths - all should return default backend
              for PATH in "/" "/foo" "/bar/baz" "/random/path"; do
                for i in $(seq 1 15); do
                  RESPONSE=$(curl -s --max-time 5 "http://${IP}${PATH}" \
                    -H "Host: any-host.example.com" 2>/dev/null || true)
                  if echo "$RESPONSE" | grep -q "$EXPECTED"; then
                    echo "HTTP response OK for path $PATH"
                    break
                  fi
                  if [ $i -eq 15 ]; then
                    echo "FAILED: Expected '$EXPECTED' for path $PATH, got '$RESPONSE'"
                    exit 1
                  fi
                  sleep 3
                done
              done
              echo "All paths return default backend"
            check:
              ($error == null): true

    # Step 6: Delete Ingress and verify cleanup
    - name: cleanup
      description: Delete Ingress and verify Route CRD removed
      cluster: tenant1
      try:
        - script:
            skipCommandOutput: true
            timeout: 120s
            content: |
              kubectl delete ingress echo-default -n default --wait=false
              echo "Ingress deletion initiated"
            check:
              ($error == null): true
      finally:
        - script:
            skipCommandOutput: true
            cluster: tenant1
            timeout: 120s
            content: |
              kubectl delete ingress echo-default -n default --ignore-not-found
              kubectl delete service echo-default -n default --ignore-not-found

    - name: verify-cleanup
      description: Verify Route CRD removed
      use:
        template: ../../../../step-templates/common/verify-route-cleanup.yaml
        with:
          bindings:
            - name: resource_name
              value: ($name)
            - name: kubelb_namespace
              value: ($kubelb_namespace)
