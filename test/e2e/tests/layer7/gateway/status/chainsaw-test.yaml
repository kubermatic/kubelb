# Copyright 2026 The KubeLB Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Gateway Status Propagation Test
# Verifies:
# - Gateway status is properly propagated from kubelb cluster to tenant cluster
# - Addresses are populated in tenant Gateway status
# - Listener status conditions are propagated
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: status-gateway
  labels:
    all:
    test: status
    resource: gateway
    layer: layer7
spec:
  description: |
    Test Gateway status propagation.
    Creates Gateway on tenant1, verifies status fields are
    propagated from kubelb cluster back to tenant.
  bindings:
    - name: name
      value: gw-status
    - name: namespace
      value: default
    - name: kubelb_namespace
      value: tenant-primary
  steps:
    # Step 1: Create Gateway
    - name: create-gateway
      description: Create Gateway with kubelb class
      cluster: tenant1
      try:
        - apply:
            resource:
              apiVersion: gateway.networking.k8s.io/v1
              kind: Gateway
              metadata:
                name: gw-status
                namespace: default
              spec:
                gatewayClassName: kubelb
                listeners:
                  - name: http
                    protocol: HTTP
                    port: 80
                    allowedRoutes:
                      namespaces:
                        from: All

    # Step 2: Wait for generated Gateway in kubelb to have status
    - name: wait-kubelb-status
      description: Wait for generated Gateway in kubelb to have status
      cluster: kubelb
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              set -e
              NAMESPACE="tenant-primary"
              GATEWAY_NAME="gw-status"

              for i in $(seq 1 10); do
                GEN_GW=$(kubectl get gateway -n "$NAMESPACE" \
                  -l kubelb.k8c.io/origin-name="$GATEWAY_NAME" -o name 2>/dev/null | head -1)

                if [ -n "$GEN_GW" ]; then
                  IP=$(kubectl get $GEN_GW -n "$NAMESPACE" \
                    -o jsonpath='{.status.addresses[0].value}' 2>/dev/null || true)
                  if [ -n "$IP" ]; then
                    echo "Generated Gateway has address: $IP"
                    exit 0
                  fi
                fi
                sleep 2
              done
              echo "FAILED: Generated Gateway has no address"
              exit 1
            check:
              ($error == null): true

    # Step 3: Verify addresses propagated to tenant
    - name: verify-addresses
      description: Verify addresses are propagated to tenant Gateway
      cluster: tenant1
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              set -e
              for i in $(seq 1 20); do
                IP=$(kubectl get gateway gw-status -n default \
                  -o jsonpath='{.status.addresses[0].value}' 2>/dev/null || true)
                if [ -n "$IP" ]; then
                  echo "Tenant Gateway has address: $IP"

                  # Verify address type
                  TYPE=$(kubectl get gateway gw-status -n default \
                    -o jsonpath='{.status.addresses[0].type}' 2>/dev/null || true)
                  echo "  Address type: $TYPE"
                  exit 0
                fi
                sleep 2
              done
              echo "FAILED: Tenant Gateway has no address"
              kubectl get gateway gw-status -n default -o yaml
              exit 1
            check:
              ($error == null): true

    # Step 4: Verify listener status propagated
    - name: verify-listener-status
      description: Verify listener status conditions propagated
      cluster: tenant1
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              set -e
              for i in $(seq 1 20); do
                # Check if listeners status exists
                LISTENERS=$(kubectl get gateway gw-status -n default \
                  -o jsonpath='{.status.listeners}' 2>/dev/null || true)
                if [ -n "$LISTENERS" ] && [ "$LISTENERS" != "[]" ]; then
                  echo "Tenant Gateway has listener status"
                  echo "Listeners: $LISTENERS"
                  exit 0
                fi
                sleep 2
              done
              # Listener status may not always be available, so this is a soft check
              echo "WARNING: Listener status not propagated (may be expected)"
              exit 0
            check:
              ($error == null): true

    # Step 5: Cleanup
    - name: cleanup
      description: Delete Gateway
      cluster: tenant1
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              kubectl delete gateway gw-status -n default --wait=false
              echo "Cleanup initiated"
            check:
              ($error == null): true
      finally:
        - script:
            skipCommandOutput: true
            cluster: tenant1
            timeout: 60s
            content: |
              kubectl delete gateway gw-status -n default --ignore-not-found

    - name: verify-cleanup
      description: Verify Route CRD removed
      use:
        template: ../../../../step-templates/common/verify-route-cleanup.yaml
        with:
          bindings:
            - name: resource_name
              value: ($name)
            - name: kubelb_namespace
              value: ($kubelb_namespace)
