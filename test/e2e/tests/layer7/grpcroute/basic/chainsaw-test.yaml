# Copyright 2026 The KubeLB Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Basic GRPCRoute Test
# Verifies:
# - GRPCRoute referencing Gateway creates Route CRD in kubelb cluster
# - Route CRD has correct labels (origin-name, origin-resource-kind)
# - gRPC connectivity via grpcurl
# - GRPCRoute deletion removes Route CRD from kubelb cluster
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: basic-grpcroute
  labels:
    all:
    test: basic
    resource: grpcroute
    layer: layer7
spec:
  description: |
    Test basic GRPCRoute full lifecycle.
    Deploys yages gRPC server on tenant1, creates Gateway and GRPCRoute,
    verifies Route CRD in kubelb cluster, tests gRPC connectivity,
    then verifies cleanup removes Route CRD.
  bindings:
    - name: namespace
      value: default
    - name: kubelb_namespace
      value: tenant-primary
    - name: name
      value: grpc-basic
  steps:
    # Step 1: Deploy gRPC backend service (grpcbin - supports reflection)
    - name: deploy-backend
      description: Deploy grpcbin gRPC server
      cluster: tenant1
      try:
        - apply:
            resource:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: grpc-yages
                namespace: default
                labels:
                  app: grpc-yages
              spec:
                replicas: 1
                selector:
                  matchLabels:
                    app: grpc-yages
                template:
                  metadata:
                    labels:
                      app: grpc-yages
                  spec:
                    containers:
                      - name: grpcbin
                        image: docker.io/kong/grpcbin@sha256:6535251b38b0be84c9ba26b1eb00921f5c78a25052b06a117677d302bbc861ce
                        imagePullPolicy: IfNotPresent
                        ports:
                          - containerPort: 9000
                            name: grpc
                            protocol: TCP
                          - containerPort: 9001
                            name: grpcs
                            protocol: TCP
        - apply:
            resource:
              apiVersion: v1
              kind: Service
              metadata:
                name: grpc-yages
                namespace: default
              spec:
                type: ClusterIP
                selector:
                  app: grpc-yages
                ports:
                  - port: 9000
                    targetPort: 9000
                    protocol: TCP
        - assert:
            timeout: 120s
            resource:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: grpc-yages
                namespace: default
              status:
                readyReplicas: 1

    # Step 2: Create Gateway for GRPCRoute
    - name: create-gateway
      description: Create Gateway for GRPCRoute to reference
      cluster: tenant1
      try:
        - apply:
            resource:
              apiVersion: gateway.networking.k8s.io/v1
              kind: Gateway
              metadata:
                name: grpc-gw
                namespace: default
              spec:
                gatewayClassName: kubelb
                listeners:
                  - name: grpc
                    protocol: HTTP
                    port: 80
                    allowedRoutes:
                      namespaces:
                        from: All
                      kinds:
                        - kind: GRPCRoute

    # Step 3: Wait for Gateway to have address
    - name: wait-gateway-ready
      description: Wait for Gateway to have address (can take ~60s for LB IP)
      cluster: tenant1
      try:
        - script:
            skipCommandOutput: true
            timeout: 120s
            content: |
              set -e
              for i in $(seq 1 40); do
                IP=$(kubectl get gateway grpc-gw -n default \
                  -o jsonpath='{.status.addresses[0].value}' 2>/dev/null || true)
                if [ -n "$IP" ]; then
                  echo "Gateway ready with IP: $IP"
                  exit 0
                fi
                echo "Attempt $i: waiting for Gateway LB IP..."
                sleep 3
              done
              echo "FAILED: Gateway not ready"
              kubectl get gateway grpc-gw -n default -o yaml
              exit 1
            check:
              ($error == null): true

    # Step 4: Create GRPCRoute
    - name: create-grpcroute
      description: Create GRPCRoute referencing Gateway
      cluster: tenant1
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              set -e
              IP=$(kubectl get gateway grpc-gw -n default \
                -o jsonpath='{.status.addresses[0].value}')
              HOST="grpc-basic.${IP}.nip.io"
              cat <<EOF | kubectl apply -f -
              apiVersion: gateway.networking.k8s.io/v1
              kind: GRPCRoute
              metadata:
                name: grpc-basic
                namespace: default
              spec:
                parentRefs:
                  - name: grpc-gw
                hostnames:
                  - "${HOST}"
                rules:
                  - backendRefs:
                      - name: grpc-yages
                        port: 9000
              EOF
              echo "Created GRPCRoute with host: $HOST"
            check:
              ($error == null): true

    # Verify Route CRD in kubelb cluster
    - name: verify-route-crd
      description: Verify Route CRD exists with correct labels
      use:
        template: ../../../../step-templates/common/verify-route-crd.yaml
        with:
          bindings:
            - name: resource_name
              value: ($name)
            - name: expected_kind
              value: GRPCRoute.gateway.networking.k8s.io
            - name: kubelb_namespace
              value: ($kubelb_namespace)

    # Step 6: Verify gRPC connectivity
    - name: verify-grpc
      description: Verify gRPC response via grpcurl
      cluster: tenant1
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              set -e
              IP=$(kubectl get gateway grpc-gw -n default \
                -o jsonpath='{.status.addresses[0].value}')
              HOST="grpc-basic.${IP}.nip.io"

              for i in $(seq 1 10); do
                # Use grpcurl to test the grpcbin HelloService
                RESPONSE=$(kubectl run grpcurl-test-$$-$i -n default --rm -i --restart=Never \
                  --image=fullstorydev/grpcurl:v1.9.1 \
                  -- -plaintext -authority "${HOST}" -d '{"greeting":"test"}' "${IP}:80" hello.HelloService/SayHello 2>&1 || true)
                if echo "$RESPONSE" | grep -q "reply"; then
                  echo "gRPC response OK: reply received"
                  exit 0
                fi
                sleep 2
              done
              echo "FAILED: Expected 'reply' in response, got '$RESPONSE'"
              exit 1
            check:
              ($error == null): true

    # Step 8: Cleanup
    - name: cleanup
      description: Delete GRPCRoute and verify Route CRD removed
      cluster: tenant1
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              kubectl delete grpcroute grpc-basic -n default --wait=false
              echo "GRPCRoute deletion initiated"
            check:
              ($error == null): true
      finally:
        - script:
            skipCommandOutput: true
            cluster: tenant1
            timeout: 60s
            content: |
              kubectl delete grpcroute grpc-basic -n default --ignore-not-found
              kubectl delete gateway grpc-gw -n default --ignore-not-found
              kubectl delete deployment grpc-yages -n default --ignore-not-found
              kubectl delete service grpc-yages -n default --ignore-not-found

    - name: verify-cleanup
      description: Verify Route CRD removed
      use:
        template: ../../../../step-templates/common/verify-route-cleanup.yaml
        with:
          bindings:
            - name: resource_name
              value: ($name)
            - name: kubelb_namespace
              value: ($kubelb_namespace)
