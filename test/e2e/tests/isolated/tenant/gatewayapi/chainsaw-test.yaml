# Copyright 2026 The KubeLB Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Tenant Gateway API Settings Test
# Verifies:
# - Tenant.spec.gatewayAPI.class overrides Config
# - Tenant.spec.gatewayAPI.disable disables Gateway API for tenant
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: tenant-gatewayapi
  labels:
    all:
    isolated: "true"
    resource: tenant
    feature: gatewayapi
spec:
  concurrent: false
  description: |
    Test that Tenant.spec.gatewayAPI settings work correctly for
    per-tenant Gateway API configuration.
  steps:
    - name: reset-tenants
      description: Reset Tenants to default state
      use:
        template: ../../../../step-templates/isolated/reset-tenants.yaml
        with:
          bindings:
            - name: manifestsPath
              value: ../../../../manifests

    - name: patch-tenant-with-gateway-class
      description: Set custom gateway class for tenant
      cluster: kubelb
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              set -e
              kubectl patch tenant primary --type=merge -p '{
                "spec": {
                  "gatewayAPI": {
                    "class": "tenant-gateway-class"
                  }
                }
              }'
              echo "SUCCESS: Tenant patched with gateway class"
            check:
              ($error == null): true

    - name: verify-tenant-gateway-class-set
      description: Verify tenant has custom gateway class
      cluster: kubelb
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              set -e
              CLASS=$(kubectl get tenant primary -o jsonpath='{.spec.gatewayAPI.class}')
              if [ "$CLASS" = "tenant-gateway-class" ]; then
                echo "SUCCESS: Tenant gateway class is 'tenant-gateway-class'"
                exit 0
              fi
              echo "FAILED: Tenant gateway class is '$CLASS'"
              exit 1
            check:
              ($error == null): true

    - name: test-full-gateway-disable
      description: Test fully disabling Gateway API for tenant
      cluster: kubelb
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              set -e
              kubectl patch tenant primary --type=merge -p '{
                "spec": {
                  "gatewayAPI": {
                    "disable": true
                  }
                }
              }'
              echo "SUCCESS: Tenant Gateway API fully disabled"
            check:
              ($error == null): true

    - name: verify-gateway-disabled
      description: Verify Gateway API is disabled
      cluster: kubelb
      try:
        - script:
            skipCommandOutput: true
            timeout: 60s
            content: |
              set -e
              DISABLED=$(kubectl get tenant primary -o jsonpath='{.spec.gatewayAPI.disable}')
              if [ "$DISABLED" = "true" ]; then
                echo "SUCCESS: Gateway API is disabled"
                exit 0
              fi
              echo "FAILED: Gateway API disabled flag is '$DISABLED'"
              exit 1
            check:
              ($error == null): true
      finally:
        - script:
            cluster: kubelb
            skipCommandOutput: true
            timeout: 60s
            content: |
              kubectl replace -f ../../../../manifests/tenants/primary.yaml
