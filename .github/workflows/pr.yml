name: PR Security & Compliance

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: go.mod

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Dependency Review
        uses: actions/dependency-review-action@3b139cfc5fae8b618d3eae3675e383bb1769c019 # v4.5.0
        with:
          fail-on-severity: high
          comment-summary-in-pr: on-failure
          fail-on-scopes: runtime, development

  scan-images:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: kubelb
            dockerfile: kubelb.dockerfile
          - name: ccm
            dockerfile: ccm.dockerfile
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f7ce87c1d6bead3e36075b2ce75da1f6cc28aaca # v3.9.0

      - name: Build ${{ matrix.image.name }}
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
        with:
          context: .
          file: ${{ matrix.image.dockerfile }}
          platforms: linux/amd64
          load: true
          tags: ${{ matrix.image.name }}:pr-scan
          cache-from: type=gha,scope=${{ matrix.image.name }}
          cache-to: type=gha,mode=min,scope=${{ matrix.image.name }}

      - name: Scan ${{ matrix.image.name }}
        uses: aquasecurity/trivy-action@18f2510ee396bbf400402947b394f2dd8c87dbb0 # v0.28.0
        with:
          image-ref: ${{ matrix.image.name }}:pr-scan
          exit-code: "1"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true
          format: "sarif"
          output: "trivy-${{ matrix.image.name }}.sarif"

      - name: Upload ${{ matrix.image.name }} scan results
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
        if: always()
        with:
          sarif_file: trivy-${{ matrix.image.name }}.sarif
          category: ${{ matrix.image.name }}

  scan-summary:
    runs-on: ubuntu-latest
    needs: scan-images
    if: failure()
    steps:
      - name: Comment PR on failure
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Security Scan Failed** - HIGH or CRITICAL vulnerabilities found. Check the workflow logs for details.'
            })

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@18f2510ee396bbf400402947b394f2dd8c87dbb0 # v0.28.0
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "HIGH,CRITICAL"
          exit-code: "1"
          scanners: "misconfig,secret"
          format: "sarif"
          output: "trivy-fs.sarif"

      - name: Upload filesystem scan results
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
        if: always()
        with:
          sarif_file: trivy-fs.sarif
          category: filesystem
