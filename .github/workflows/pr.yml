name: PR Security & Compliance

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: high
          comment-summary-in-pr: on-failure
          fail-on-scopes: runtime, development

  scan-images:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: kubelb
            dockerfile: kubelb.dockerfile
          - name: ccm
            dockerfile: ccm.dockerfile
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build ${{ matrix.image.name }}
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ${{ matrix.image.dockerfile }}
          platforms: linux/amd64
          load: true
          tags: ${{ matrix.image.name }}:pr-scan
          cache-from: type=gha,scope=${{ matrix.image.name }}
          cache-to: type=gha,mode=min,scope=${{ matrix.image.name }}

      - name: Scan ${{ matrix.image.name }}
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.28.0
        with:
          image-ref: ${{ matrix.image.name }}:pr-scan
          exit-code: "1"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true
          format: "sarif"
          output: "trivy-${{ matrix.image.name }}.sarif"

      - name: Upload ${{ matrix.image.name }} scan results
        uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
        if: always()
        with:
          sarif_file: trivy-${{ matrix.image.name }}.sarif
          category: ${{ matrix.image.name }}

  scan-summary:
    runs-on: ubuntu-latest
    needs: scan-images
    if: failure()
    steps:
      - name: Comment PR on failure
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Security Scan Failed** - HIGH or CRITICAL vulnerabilities found. Check the workflow logs for details.'
            })

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.28.0
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "HIGH,CRITICAL"
          exit-code: "1"
          scanners: "misconfig,secret"
          format: "sarif"
          output: "trivy-fs.sarif"

      - name: Upload filesystem scan results
        uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
        if: always()
        with:
          sarif_file: trivy-fs.sarif
          category: filesystem
