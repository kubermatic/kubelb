name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      skip_vulnerability_scans:
        description: "Skip vulnerability scanning (for testing only)"
        required: false
        default: false
        type: boolean
      dry_run:
        description: "Dry run - build but don't push artifacts"
        required: false
        default: false
        type: boolean
      tag:
        description: "Tag to release (e.g., v1.0.0-rc.1)"
        required: true
        type: string

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

env:
  REGISTRY: quay.io
  GO_VERSION: "1.25.5"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for GoReleaser to create releases
      packages: write # Needed to push images
      id-token: write # Needed for keyless signing
      security-events: write # Needed to upload Trivy SARIF results
      attestations: write
    timeout-minutes: 60
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

          # Extract addons chart version from Makefile
          ADDONS_VERSION=$(grep -E '^KUBELB_ADDONS_CHART_VERSION \?=' Makefile | cut -d'=' -f2 | tr -d ' ')
          echo "addons_version=${ADDONS_VERSION}" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@4574d27a4764455b42196d70a065bc6853246a25 # v3.4.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f7ce87c1d6bead3e36075b2ce75da1f6cc28aaca # v3.9.0
        with:
          buildkitd-config-inline: |
            [worker.oci]
              max-parallelism = 4

      - name: Configure Docker cache
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login to Quay.io
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@dc72c7d5c4d10cd6bcb8cf6e3fd625a9e5e537da # v3.7.0

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@f325610c9f50a54015d37c8d16cb3b0e2c8f4de0 # v0.18.0

      - name: Install ORAS
        uses: oras-project/setup-oras@5c0b487ce3fe0ce3ab0d034e63669e426e294e4d # v1.2.2

      - name: Login to quay.io (ORAS)
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | oras login ${{ env.REGISTRY }} \
            --username ${{ secrets.REGISTRY_USER }} --password-stdin 2>/dev/null || \
            (echo "::error::ORAS registry login failed" && exit 1)

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@9ed2f89a662bf1735a48bc8557fd212fa902bebf # v6.1.0
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KUBELB_ADDONS_VERSION: ${{ steps.version.outputs.addons_version }}

      - name: Install Trivy
        if: ${{ !inputs.skip_vulnerability_scans }}
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan images for vulnerabilities
        if: ${{ !inputs.skip_vulnerability_scans }}
        env:
          TRIVY_USERNAME: ${{ secrets.REGISTRY_USER }}
          TRIVY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          EXIT_CODE=0
          for img in kubelb-manager kubelb-ccm; do
            echo "=== Scanning quay.io/kubermatic/${img}:${VERSION} ==="
            trivy image --exit-code 1 --severity HIGH,CRITICAL --ignore-unfixed \
              --format sarif --output "trivy-${img}.sarif" \
              "quay.io/kubermatic/${img}:${VERSION}" || EXIT_CODE=1
          done
          exit $EXIT_CODE

      - name: Upload release scan results
        if: ${{ !inputs.skip_vulnerability_scans && always() }}
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
        with:
          sarif_file: trivy-kubelb-manager.sarif
          category: release-kubelb-manager

      - name: Upload release scan results (ccm)
        if: ${{ !inputs.skip_vulnerability_scans && always() }}
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
        with:
          sarif_file: trivy-kubelb-ccm.sarif
          category: release-kubelb-ccm

      - name: Generate GitHub attestation for checksums
        uses: actions/attest-build-provenance@7668571508540a607bdfd90a87a560489fe372eb # v2.1.0
        with:
          subject-path: "./dist/checksums.txt"

      - name: Generate and attach SBOMs to Docker images
        env:
          SYFT_REGISTRY_AUTH_USERNAME: ${{ secrets.REGISTRY_USER }}
          SYFT_REGISTRY_AUTH_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Generate SBOMs in parallel
          (
            echo "Generating SBOM for kubelb-manager..."
            syft quay.io/kubermatic/kubelb-manager:${VERSION} \
              -o spdx-json=dist/kubelb-manager-docker.sbom.spdx.json
          ) &

          (
            echo "Generating SBOM for kubelb-ccm..."
            syft quay.io/kubermatic/kubelb-ccm:${VERSION} \
              -o spdx-json=dist/kubelb-ccm-docker.sbom.spdx.json
          ) &

          # Wait for all parallel jobs to complete
          wait

          # Attach SBOMs sequentially (ORAS doesn't handle parallel well)
          for img in kubelb-manager kubelb-ccm; do
            echo "Attaching SBOM to ${img}..."
            oras attach quay.io/kubermatic/${img}:${VERSION} \
              --artifact-type application/spdx+json \
              --annotation "org.opencontainers.image.title=${img}-docker.sbom.spdx.json" \
              dist/${img}-docker.sbom.spdx.json:application/spdx+json
          done

      - name: Attest SBOMs to images
        run: |
          VERSION=${{ steps.version.outputs.version }}
          for img in kubelb-manager kubelb-ccm; do
            echo "Attesting SBOM for ${img}..."
            cosign attest --yes \
              --predicate dist/${img}-docker.sbom.spdx.json \
              --type spdxjson \
              quay.io/kubermatic/${img}:${VERSION}
          done

      - name: Logout from registries
        if: always()
        run: |
          docker logout ${{ env.REGISTRY }} || true
          oras logout ${{ env.REGISTRY }} || true

  helm:
    needs: release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read # Only read for checkout
      packages: write # Needed to push charts
      id-token: write # Needed for keyless signing
      attestations: write # Needed to upload GitHub attestations
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Helm
        uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v4.2.0

      - name: Install Cosign
        uses: sigstore/cosign-installer@dc72c7d5c4d10cd6bcb8cf6e3fd625a9e5e537da # v3.7.0

      - name: Login to Quay.io (for cosign)
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: quay.io
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Release Helm Charts
        env:
          REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          SIGN_CHARTS: "true"
        run: |
          make IMAGE_TAG=${{ needs.release.outputs.version }} release-charts
