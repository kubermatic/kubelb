name: Release

on:
  push:
    tags:
      - "v*"
      - "addons-v*"
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of release to perform"
        required: true
        type: choice
        options:
          - full
          - addons
        default: full
      skip_vulnerability_scans:
        description: "Skip vulnerability scanning (for testing only)"
        required: false
        default: false
        type: boolean
      dry_run:
        description: "Dry run - build but don't push artifacts"
        required: false
        default: false
        type: boolean
      tag:
        description: "Tag to release (e.g., v1.0.0-rc.1)"
        required: false
        type: string
      addons_version:
        description: "Addons chart version (for addons release type, e.g., v0.3.0)"
        required: false
        type: string

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

env:
  REGISTRY: quay.io
  GO_VERSION: "1.25.7"

jobs:
  release:
    if: ${{ !startsWith(github.ref_name, 'addons-') && inputs.release_type != 'addons' && !startsWith(github.ref, 'refs/tags/v1.2') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for GoReleaser to create releases
      packages: write # Needed to push images
      id-token: write # Needed for keyless signing
      security-events: write # Needed to upload Trivy SARIF results
      attestations: write
    timeout-minutes: 60
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

          # Extract addons chart version from Makefile
          ADDONS_VERSION=$(grep -E '^KUBELB_ADDONS_CHART_VERSION \?=' Makefile | cut -d'=' -f2 | tr -d ' ')
          echo "addons_version=${ADDONS_VERSION}" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
        with:
          buildkitd-config-inline: |
            [worker.oci]
              max-parallelism = 4

      - name: Configure Docker cache
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Login to Quay.io
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@62ad5284b8ced813296287a0b63906cb364b73ee # v0.22.0

      - name: Install ORAS
        uses: oras-project/setup-oras@22ce207df3b08e061f537244349aac6ae1d214f6 # v1.2.4

      - name: Login to quay.io (ORAS)
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | oras login ${{ env.REGISTRY }} \
            --username ${{ secrets.REGISTRY_USER }} --password-stdin 2>/dev/null || \
            (echo "::error::ORAS registry login failed" && exit 1)

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KUBELB_ADDONS_VERSION: ${{ steps.version.outputs.addons_version }}

      - name: Install Trivy
        if: ${{ !inputs.skip_vulnerability_scans }}
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan images for vulnerabilities
        if: ${{ !inputs.skip_vulnerability_scans }}
        env:
          TRIVY_USERNAME: ${{ secrets.REGISTRY_USER }}
          TRIVY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          EXIT_CODE=0
          for img in kubelb-manager kubelb-ccm; do
            echo "=== Scanning quay.io/kubermatic/${img}:${VERSION} ==="
            trivy image --exit-code 1 --severity HIGH,CRITICAL --ignore-unfixed \
              --format sarif --output "trivy-${img}.sarif" \
              "quay.io/kubermatic/${img}:${VERSION}" || EXIT_CODE=1
          done
          exit $EXIT_CODE

      - name: Upload release scan results
        if: ${{ !inputs.skip_vulnerability_scans && always() }}
        uses: github/codeql-action/upload-sarif@19b2f06db2b6f5108140aeb04014ef02b648f789 # v4.31.11
        with:
          sarif_file: trivy-kubelb-manager.sarif
          category: release-kubelb-manager

      - name: Upload release scan results (ccm)
        if: ${{ !inputs.skip_vulnerability_scans && always() }}
        uses: github/codeql-action/upload-sarif@19b2f06db2b6f5108140aeb04014ef02b648f789 # v4.31.11
        with:
          sarif_file: trivy-kubelb-ccm.sarif
          category: release-kubelb-ccm

      - name: Generate GitHub attestation for checksums
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-path: "./dist/checksums.txt"

      - name: Generate and attach SBOMs to Docker images
        env:
          SYFT_REGISTRY_AUTH_USERNAME: ${{ secrets.REGISTRY_USER }}
          SYFT_REGISTRY_AUTH_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Generate SBOMs in parallel
          (
            echo "Generating SBOM for kubelb-manager..."
            syft quay.io/kubermatic/kubelb-manager:${VERSION} \
              -o spdx-json=dist/kubelb-manager-docker.sbom.spdx.json
          ) &

          (
            echo "Generating SBOM for kubelb-ccm..."
            syft quay.io/kubermatic/kubelb-ccm:${VERSION} \
              -o spdx-json=dist/kubelb-ccm-docker.sbom.spdx.json
          ) &

          # Wait for all parallel jobs to complete
          wait

          # Attach SBOMs sequentially (ORAS doesn't handle parallel well)
          for img in kubelb-manager kubelb-ccm; do
            echo "Attaching SBOM to ${img}..."
            oras attach quay.io/kubermatic/${img}:${VERSION} \
              --artifact-type application/spdx+json \
              --annotation "org.opencontainers.image.title=${img}-docker.sbom.spdx.json" \
              dist/${img}-docker.sbom.spdx.json:application/spdx+json
          done

      - name: Attest SBOMs to images
        run: |
          VERSION=${{ steps.version.outputs.version }}
          for img in kubelb-manager kubelb-ccm; do
            echo "Attesting SBOM for ${img}..."
            cosign attest --yes \
              --predicate dist/${img}-docker.sbom.spdx.json \
              --type spdxjson \
              quay.io/kubermatic/${img}:${VERSION}
          done

      - name: Logout from registries
        if: always()
        run: |
          docker logout ${{ env.REGISTRY }} || true
          oras logout ${{ env.REGISTRY }} || true

  helm:
    if: ${{ !startsWith(github.ref_name, 'addons-') && inputs.release_type != 'addons' && !startsWith(github.ref, 'refs/tags/v1.2') }}
    needs: release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read # Only read for checkout
      packages: write # Needed to push charts
      id-token: write # Needed for keyless signing
      attestations: write # Needed to upload GitHub attestations
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Login to Quay.io (for cosign)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: quay.io
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Release Helm Charts
        env:
          REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          SIGN_CHARTS: "true"
        run: |
          make IMAGE_TAG=${{ needs.release.outputs.version }} release-charts

  helm-addons:
    if: ${{ startsWith(github.ref_name, 'addons-') || inputs.release_type == 'addons' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Get addons version
        id: version
        run: |
          if [ "${{ inputs.release_type }}" = "addons" ]; then
            echo "version=${{ inputs.addons_version }}" >> $GITHUB_OUTPUT
          else
            # Extract from tag: addons-v0.3.0 -> v0.3.0
            TAG="${GITHUB_REF#refs/tags/addons-}"
            echo "version=${TAG}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Login to Quay.io (for cosign)
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: quay.io
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Release Addons Helm Chart
        env:
          REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          SIGN_CHARTS: "true"
        run: |
          make KUBELB_ADDONS_CHART_VERSION=${{ steps.version.outputs.version }} release-addons-chart
